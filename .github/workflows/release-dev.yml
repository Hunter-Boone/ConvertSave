name: Build Dev Release

# Dev build workflow for private repository
# Required Secrets:
#   - UPDATER_GITHUB_PAT: Personal Access Token with 'repo' scope for private repo access
#     This PAT is compiled into the dev build to allow the Tauri updater to fetch updates
#     from the private GitHub releases
#   - TAURI_SIGNING_PRIVATE_KEY: Tauri signing key for update verification
#   - TAURI_SIGNING_PRIVATE_KEY_PASSWORD: Password for the signing key

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CONVERTSAVE_API_URL: "https://convert-save-website.vercel.app/api/license"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xdg-utils

      - name: Install dependencies
        run: npm ci

      - name: Set dev version
        shell: bash
        run: |
          # Use run number for consistent versioning across all platforms
          # Windows limits: major/minor <= 255, patch <= 65535
          # Using 99.0.X ensures it's always higher than production (0.x.x) and within limits
          VERSION="99.0.${{ github.run_number }}"
          echo "DEV_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Setting dev version to: $VERSION"

          # Update tauri.conf.dev.json with the new version
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.dev.json
          else
            sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.dev.json 2>/dev/null || \
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.dev.json
          fi

          echo "Updated tauri.conf.dev.json:"
          grep '"version"' src-tauri/tauri.conf.dev.json

      - name: Build Tauri app (Windows/Linux)
        if: matrix.platform != 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_PAT: ${{ secrets.UPDATER_GITHUB_PAT }}
        run: npm run tauri build -- --config src-tauri/tauri.conf.dev.json --features dev-build

      - name: Sign Windows executables with Azure Trusted Signing
        if: matrix.platform == 'windows-latest'
        uses: azure/trusted-signing-action@v0
        with:
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: ${{ secrets.AZURE_ENDPOINT }}
          trusted-signing-account-name: ${{ secrets.AZURE_CODE_SIGNING_NAME }}
          certificate-profile-name: ${{ secrets.AZURE_CERT_PROFILE_NAME }}
          files-folder: src-tauri/target/release/bundle
          files-folder-filter: exe,msi
          files-folder-recurse: true
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Regenerate Tauri signatures after code signing (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          # Find and re-sign all exe and msi files after Azure code signing
          $bundlePath = "src-tauri/target/release/bundle"

          # Re-sign NSIS exe
          $exeFiles = Get-ChildItem -Path "$bundlePath/nsis" -Filter "*.exe" -ErrorAction SilentlyContinue
          foreach ($file in $exeFiles) {
            Write-Host "Re-signing: $($file.FullName)"
            # Remove old signature file
            $sigFile = "$($file.FullName).sig"
            if (Test-Path $sigFile) { Remove-Item $sigFile }
            # Generate new signature
            npx tauri signer sign --private-key "$env:TAURI_SIGNING_PRIVATE_KEY" --password "$env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "$($file.FullName)"
          }

          # Re-sign MSI
          $msiFiles = Get-ChildItem -Path "$bundlePath/msi" -Filter "*.msi" -ErrorAction SilentlyContinue
          foreach ($file in $msiFiles) {
            Write-Host "Re-signing: $($file.FullName)"
            $sigFile = "$($file.FullName).sig"
            if (Test-Path $sigFile) { Remove-Item $sigFile }
            npx tauri signer sign --private-key "$env:TAURI_SIGNING_PRIVATE_KEY" --password "$env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "$($file.FullName)"
          }

      - name: Build Intel macOS
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_PAT: ${{ secrets.UPDATER_GITHUB_PAT }}
        run: npm run tauri build -- --target x86_64-apple-darwin --config src-tauri/tauri.conf.dev.json --features dev-build

      - name: Build Apple Silicon macOS
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_PAT: ${{ secrets.UPDATER_GITHUB_PAT }}
        run: npm run tauri build -- --target aarch64-apple-darwin --config src-tauri/tauri.conf.dev.json --features dev-build

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dev-build
          retention-days: 7
          path: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.sig
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.sig

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-dev-build
          retention-days: 7
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.sig
            src-tauri/target/release/bundle/rpm/*.sig
            src-tauri/target/release/bundle/appimage/*.sig

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-dev-build
          retention-days: 7
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.sig
            src-tauri/target/release/bundle/nsis/*.sig

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Delete existing dev release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete the existing dev release if it exists
          gh release delete dev --yes --cleanup-tag 2>/dev/null || echo "No existing dev release to delete"

      - name: Organize release files
        run: |
          set -x
          mkdir -p ./release-assets

          # Use the same version as the build job (based on run number)
          # Must match the build step: 99.0.{run_number}
          VERSION="99.0.${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Dev Version: $VERSION"

          # Helper function to move files
          move_asset() {
            local src="$1"
            local os="$2"
            local arch="$3"
            
            if [ -f "$src" ]; then
               local ext="${src##*.}"
               if [[ "$src" == *.tar.gz ]]; then
                  ext="tar.gz"
               fi
               
               if [[ "$src" == *.sig ]]; then
                   local bin_ext
                   if [[ "$src" == *.tar.gz.sig ]]; then
                      bin_ext="tar.gz"
                   else
                      bin_ext=$(echo "$src" | sed 's/\.sig$//' | sed 's/.*\.//')
                   fi
                   local new_name="ConvertSave-Dev_${os}_${arch}.${bin_ext}.sig"
                   cp "$src" "./release-assets/$new_name"
                   echo "Copied: $src -> ./release-assets/$new_name"
               else
                   local new_name="ConvertSave-Dev_${os}_${arch}.${ext}"
                   cp "$src" "./release-assets/$new_name"
                   echo "Copied: $src -> ./release-assets/$new_name"
               fi
            fi
          }

          # Linux
          find linux-dev-build -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.sig" \) 2>/dev/null | while read file; do
            if echo "$file" | grep -q "amd64\|x86_64"; then arch="x86_64";
            elif echo "$file" | grep -q "arm64\|aarch64"; then arch="arm64";
            else arch="x86_64"; fi
            
            move_asset "$file" "Linux" "$arch"
          done

          # macOS
          find macos-dev-build -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.sig" \) 2>/dev/null | while read file; do
             if echo "$file" | grep -q "aarch64"; then arch="arm64";
             elif echo "$file" | grep -q "x86_64"; then arch="x86_64";
             else arch="universal"; fi
             
             move_asset "$file" "macOS" "$arch"
          done

          # Windows
          find windows-dev-build -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.sig" \) 2>/dev/null | while read file; do
             if echo "$file" | grep -q "x64\|x86_64\|amd64"; then arch="x64";
             elif echo "$file" | grep -q "arm64\|aarch64"; then arch="arm64";
             else arch="x64"; fi
             
             move_asset "$file" "Windows" "$arch"
          done

          ls -lah ./release-assets/

      - name: Generate updater JSON
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");
            
            const version = process.env.VERSION;
            const assetsDir = "./release-assets";
            const repo = "Hunter-Boone/ConvertSave";
            const tag = "dev";
            
            const platforms = {};
            
            const files = fs.readdirSync(assetsDir);
            
            files.forEach(file => {
              if (file.endsWith(".sig")) return;
              
              const sigFile = file + ".sig";
              if (!files.includes(sigFile)) return;
              
              const signature = fs.readFileSync(path.join(assetsDir, sigFile), "utf8").trim();
              const url = `https://github.com/${repo}/releases/download/${tag}/${file}`;
              
              let platformKey = "";
              
              if (file.includes("macOS_arm64.tar.gz")) platformKey = "darwin-aarch64";
              else if (file.includes("macOS_x86_64.tar.gz")) platformKey = "darwin-x86_64";
              else if (file.includes("Linux_x86_64.AppImage")) platformKey = "linux-x86_64";
              else if (file.includes("Windows_x64.exe")) platformKey = "windows-x86_64";
              
              if (platformKey) {
                platforms[platformKey] = { signature, url };
              }
            });
            
            const manifest = {
              version,
              notes: "Development build - " + new Date().toISOString().split("T")[0],
              pub_date: new Date().toISOString(),
              platforms
            };
            
            fs.writeFileSync("./release-assets/latest.json", JSON.stringify(manifest, null, 2));
            console.log("Generated latest.json:", JSON.stringify(manifest, null, 2));
          '

      - name: Create Dev Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-assets/*
          tag_name: dev
          name: ConvertSave Dev Build
          body: |
            ## Development Build

            **Commit:** ${{ github.sha }}
            **Built:** ${{ github.event.head_commit.timestamp || 'Manual trigger' }}

            This is a development build that points to the Vercel preview API.
            It uses a separate app data folder (`com.convertsave.dev`) and can be installed alongside production.

            ### Downloads
            - **Windows**: `ConvertSave-Dev_Windows_x64.exe`
            - **macOS Intel**: `ConvertSave-Dev_macOS_x86_64.dmg`
            - **macOS Apple Silicon**: `ConvertSave-Dev_macOS_arm64.dmg`
            - **Linux**: `ConvertSave-Dev_Linux_x86_64.AppImage`

            ⚠️ This release is automatically replaced on each dev build.
          draft: false
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Dev Build Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`dev\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from [Releases](https://github.com/${{ github.repository }}/releases/tag/dev)" >> $GITHUB_STEP_SUMMARY
