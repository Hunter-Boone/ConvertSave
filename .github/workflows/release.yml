name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf xdg-utils

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app (Windows/Linux)
        if: matrix.platform != 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build

      - name: Build Intel macOS
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --target x86_64-apple-darwin

      - name: Build Apple Silicon macOS
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --target aarch64-apple-darwin

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          retention-days: 1
          path: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.sig
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.sig

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-latest' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          retention-days: 1
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.sig
            src-tauri/target/release/bundle/rpm/*.sig
            src-tauri/target/release/bundle/appimage/*.sig

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          retention-days: 1
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.sig
            src-tauri/target/release/bundle/nsis/*.sig

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Organize release files
        run: |
          set -x  # Enable debug output
          mkdir -p ./release-assets

          # Extract version from tag (e.g., v0.4.0 -> 0.4.0)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Version: $VERSION"

          # Move files to release-assets with consistent naming
          # This logic needs to handle .sig files too now

          # Helper function to move files
          move_asset() {
            local src="$1"
            local pattern="$2"
            local os="$3"
            local arch="$4"
            
            if [ -f "$src" ]; then
               local ext="${src##*.}"
               # If it's a signature file, keep .sig extension but match base name
               if [[ "$src" == *.sig ]]; then
                   # For sig files, we want file.ext.sig
                   # But our previous step might have renamed the binary to specific name
                   # So we should probably rename binary first, then rename sig to match binary name + .sig
                   # Simplified approach: Just copy everything to release-assets
                   # Tauri v2 updater usually looks for exact filenames or uses a manifest
                   # Let's just copy them for now and let the updater generator handle it?
                   # Actually, for cross-platform consistency, renaming is good.
                   
                   # New naming convention: ConvertSave_VERSION_OS_ARCH.ext[.sig]
                   local new_name="ConvertSave_${VERSION}_${os}_${arch}.${ext}"
                   
                   # Special case for .sig files which usually append .sig to the full binary name
                   if [[ "$src" == *.sig ]]; then
                      # e.g. binary.dmg.sig
                      # We want ConvertSave_..._macOS_...dmg.sig
                      # The extension passed in was 'sig', so new_name is ...arch.sig
                      # That's not quite right, signatures are usually binary_filename.sig
                      
                      # Let's assume src is like `bundle.dmg.sig`
                      # We want `ConvertSave_...dmg.sig`
                      
                      # Get the extension of the binary it signs (e.g., 'dmg' from 'dmg.sig')
                      local bin_ext=$(echo "$src" | sed 's/\.sig$//' | sed 's/.*\.//')
                      new_name="ConvertSave_${VERSION}_${os}_${arch}.${bin_ext}.sig"
                   else
                      new_name="ConvertSave_${VERSION}_${os}_${arch}.${ext}"
                   fi
                   
                   cp "$src" "./release-assets/$new_name"
                   echo "Copied: $src -> ./release-assets/$new_name"
               else
                   local new_name="ConvertSave_${VERSION}_${os}_${arch}.${ext}"
                   cp "$src" "./release-assets/$new_name"
                   echo "Copied: $src -> ./release-assets/$new_name"
               fi
            fi
          }

          # Linux
          find linux-build -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.sig" \) 2>/dev/null | while read file; do
            if echo "$file" | grep -q "amd64\|x86_64"; then arch="x86_64";
            elif echo "$file" | grep -q "arm64\|aarch64"; then arch="arm64";
            else arch="x86_64"; fi
            
            move_asset "$file" "" "Linux" "$arch"
          done

          # macOS
          find macos-build -type f \( -name "*.dmg" -o -name "*.sig" \) 2>/dev/null | while read file; do
             if echo "$file" | grep -q "aarch64"; then arch="arm64";
             elif echo "$file" | grep -q "x86_64"; then arch="x86_64";
             else arch="universal"; fi
             
             move_asset "$file" "" "macOS" "$arch"
          done

          # Windows
          find windows-build -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.sig" \) 2>/dev/null | while read file; do
             if echo "$file" | grep -q "x64\|x86_64\|amd64"; then arch="x64";
             elif echo "$file" | grep -q "arm64\|aarch64"; then arch="arm64";
             else arch="x64"; fi
             
             move_asset "$file" "" "Windows" "$arch"
          done

          ls -lah ./release-assets/

      - name: Generate updater JSON
        run: |
          # Generate latest.json for Tauri updater
          # Format:
          # {
          #   "version": "0.4.2",
          #   "notes": "Release notes...",
          #   "pub_date": "...",
          #   "platforms": {
          #     "darwin-aarch64": { "signature": "...", "url": "..." },
          #     "darwin-x86_64": { "signature": "...", "url": "..." },
          #     "linux-x86_64": { "signature": "...", "url": "..." },
          #     "windows-x86_64": { "signature": "...", "url": "..." }
          #   }
          # }

          node -e '
            const fs = require("fs");
            const path = require("path");
            
            const version = process.env.GITHUB_REF_NAME.replace(/^v/, "");
            const assetsDir = "./release-assets";
            const repo = "Hunter-Boone/ConvertSave-Support"; // Target repo
            
            const platforms = {};
            
            const files = fs.readdirSync(assetsDir);
            
            files.forEach(file => {
              if (file.endsWith(".sig")) return;
              
              const sigFile = file + ".sig";
              if (!files.includes(sigFile)) return; // Skip if no signature
              
              const signature = fs.readFileSync(path.join(assetsDir, sigFile), "utf8").trim();
              const url = `https://github.com/${repo}/releases/download/${process.env.GITHUB_REF_NAME}/${file}`;
              
              let platformKey = "";
              
              // Map our filenames to Tauri platform keys
              if (file.includes("macOS_arm64.dmg")) platformKey = "darwin-aarch64";
              else if (file.includes("macOS_x86_64.dmg")) platformKey = "darwin-x86_64";
              else if (file.includes("Linux_x86_64.AppImage")) platformKey = "linux-x86_64"; // AppImage is usually preferred for updater
              else if (file.includes("Windows_x64.exe")) platformKey = "windows-x86_64"; // Setup exe preferred over MSI usually? Or MSI? Tauri supports both but setup exe (NSIS) is standard.
              
              // If we have a match
              if (platformKey) {
                platforms[platformKey] = {
                  signature,
                  url
                };
              }
            });
            
            const manifest = {
              version,
              notes: "See release notes on GitHub.",
              pub_date: new Date().toISOString(),
              platforms
            };
            
            fs.writeFileSync("./release-assets/latest.json", JSON.stringify(manifest, null, 2));
            console.log("Generated latest.json:", JSON.stringify(manifest, null, 2));
          '

      - name: Create Release in Support Repo
        uses: softprops/action-gh-release@v1
        with:
          files: ./release-assets/*
          name: ConvertSave ${{ github.ref_name }}
          repository: Hunter-Boone/ConvertSave-Support
          token: ${{ secrets.SUPPORT_REPO_TOKEN }}
          body: |
            ## ConvertSave ${{ github.ref_name }}

            ### Downloads
            - **Windows**: `ConvertSave_*_Windows_x64.exe`
            - **macOS Intel**: `ConvertSave_*_macOS_x86_64.dmg`
            - **macOS Apple Silicon**: `ConvertSave_*_macOS_arm64.dmg`
            - **Linux**: `ConvertSave_*_Linux_x86_64.AppImage`

            See the full changelog and details in the application.
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
